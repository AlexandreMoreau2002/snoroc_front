name: Build and Deploy

on:
  push:
    branches:
      - develop

permissions:
  contents: read

jobs:
  build:
    name: Build front
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Exposer la version applicative
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "REACT_APP_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build front
        run: |
          npm run build
          ls -lh build
        env:
          CI: false
          GENERATE_SOURCEMAP: false

      - name: Create deployment archive
        run: |
          set -euxo pipefail
          tar -czf snoroc_front.tar.gz build
          ls -lh snoroc_front.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: snoroc_front
          path: snoroc_front.tar.gz
          if-no-files-found: error

  deploy:
    name: Deploy front
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: snoroc_front
          path: .

      - name: Copy archive via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: 'snoroc_front.tar.gz'
          target: '/tmp'
          rm: false
          overwrite: true

      - name: Deploy front and reload Nginx
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euxo pipefail
            echo "ðŸš€ DÃ©ploiement du front en cours..."

            REMOTE_ROOT="/srv/snoroc_dev"
            PROJECT_DIR="${REMOTE_ROOT}/snoroc_front"
            ARCHIVE="/tmp/snoroc_front.tar.gz"

            mkdir -p "$PROJECT_DIR"

            if [ -d "${PROJECT_DIR}/build" ]; then
              BACKUP_DIR="${PROJECT_DIR}/build_$(date +%Y%m%d%H%M%S)"
              mv "${PROJECT_DIR}/build" "$BACKUP_DIR"
              echo "Ancienne version sauvegardÃ©e dans ${BACKUP_DIR}"
            fi

            tar -xzf "$ARCHIVE" -C "$PROJECT_DIR"
            rm -f "$ARCHIVE"

            sudo systemctl reload nginx

            echo "âœ… Front dÃ©ployÃ© et Nginx rechargÃ©"
